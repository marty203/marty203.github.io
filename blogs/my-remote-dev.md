# 我的远程开发之路

## 源起

 我嫌自己的笔记本电脑性能差。一开始想买高性能笔记本电脑，比如 MacBook Pro，却发生了散热差导致降频门；然后考虑买台式机，散热和性能得到保证，但是即使是 Mac mini 也不太方便；最后了解到 Linux 世界的程序猿都在用 SSH 连开发服务器来写代码，这样对笔记本电脑的性能并没有太高要求。
 
 可是 Linux 的童鞋都是用的 Terminal 和 Vim 等在开发，对代码智能提示和定义引用跳转没有太大依赖，如果我写 C# 程序没有这些会很不优雅。而现在这一切随着 VS Code Remote Development 的横空出世都得到了解决。
 
 于是我开始研究，如何把开发用的代码数据库之类，全都搬到服务器上，再用本地笔记本电脑 SSH 连接服务器进行开发，同时 VS Code 的一切开发功能都得以保留，就彷佛这些代码文件都在我本地笔记本电脑一样。当然对于 Linux 我还是初学者，所以这里只是记录我的闯关之路，因此会出现一些很简单的知识总结。
 
 话不多说，进入正题。

## 第一步，模拟服务器

### 云服务器

 公司给提供开发服务器的童鞋肯定直接连公司服务器了。而我选择云服务器，像 AWS、Azure、Google Cloud、AliYun 以及国内的各种云，由于都是微软的我先尝试了微软的 Azure。只要在 Azure 上创建一个虚拟服务器，并将本地生成的 SSH 密钥对的公玥添加进去，VS Code 就可以直接连接。
 
 VS Code 远程开发有3种模式：WSL、Container、SSH，云服务器一般都用 SSH（可能也会用到容器，因为云服务器上也可以用 Docker，但是我没用过），Azure 也是使用 SSH 这种方式。由于 Azure 虚拟服务器都是可视化设置，不需要太多配置，很简单，而 VS Code 连接时输入 Azure 给生成的 domain / ip 即可。连接成功后，VS Code 的 Terminal 直接运行的就是服务器的环境，可以安装一些工具，比如 git、nodejs、npm、dotnet 等等。
 
 我选的发行版是 Ubuntu 16.04 / 18.04，因为我入门 Linux 用的 Ubuntu Desktop 14.04，这样会更熟悉一些。成功地看到了 hello world 代表我已经入门了远程开发模式。

### 挫败

 我的微软 Azure 账号已经没有免费额度了，另外我在连 Azure 服务器开发时，感觉输入字符会有些许延迟。因此我在想有没有更便宜更快的云服务器，因为是自己开发，没有什么访问流量，而且对性能也不是要求太高，只要程序能跑起来即可。但是换了其他云服务器，就没有 Azure 这么详细指导了，服务器的一切配置都要自己来，对于 Linux 高手可能不算什么，但是对于现在的我还是很有挑战。而云服务器还需要花钱，那么我想自己先熟悉一下，然后再花钱买云服务器，这时自然想到了虚拟机。
 
 虚拟机我选的是 Virtual Box，一个是免费，另一个是各平台通用，我本地笔记本电脑也不会只使用一个系统平台。由于搞服务器，而且虚拟机还很占资源，所以就想着能不能搞个无桌面的服务器版本，于是 Ubuntu Server 18.04 下载并安装到虚拟机中。最开始虚拟机设置的 NAT 网络连接方式，进入到 Linux 中，其实就相当于桌面版只能用终端，其他 GUI 软件没法用而已。
 
 愉快的下载了自己的程序需要的开发工具，也成功看到了 hello world，于是进入到远程开发模式，然后就没然后了。因为服务器版系统没有 WIFI 驱动，而我用的是笔记本，研究了一下 Virtual Box 的网络连接方式，如果想主机访问虚拟机，只能选择桥接模式，而桥接模式其实是网卡内部搞出一条通路连接路由器。这样对于虚拟机的 Linux 系统也是使用无线网卡，而 Ubuntu 的服务器版本默认的场景是服务器机房，一般都是有线网络，因此默认没有 WIFI 驱动。可是我用的是笔记本电脑，一般都不会连接网线，这就凉凉了。
 
 虚拟机系统可以不访问外网，但是需要能让主机通过 ip 形式访问虚拟机，现在没办法进行下去了，WIFI 驱动不会装，任务失败！不过后来我有个想法，既然桌面版有 WIFI 驱动，那么能不能把桌面版的驱动提取出来，安装到服务器版中，这目前还没实践。

### 迂回前行

 服务器版没有 WIFI 驱动这个问题不重要，因为最终是要用云服务器，云服务器肯定有网络的。那么我这条远程开发之路还是要走下去，当初选服务器版其实只是想要降低虚拟机的资源占用，既然现在不行就改用回桌面版。而 Virtual Box 有无界面模式，这样也可以凑合用了，假装成服务器版本。当然那些 GUI 软件不用了，所以安装系统时选的最小化安装，但是第三方驱动还是仍然勾选上，其实要的就是这第三方驱动中 WIFI 驱动。
 
 首先正常启动，进入终端，查看当前 ip 地址，记录下来一会儿会用到。然后如果没有 openssh-server 安装之，安装好以后找 SSH 配置文件 ```/etc/ssh/ssh_config``` ，里面端口号默认注释掉。默认端口号为22，这里改成一个5位数端口号，一个为了防止端口扫描，一个有些服务器会要求端口号不小于5位。然后通过 Virtual Box 共享文件夹功能，把本地生成的公玥复制到 ```~/.ssh/``` 目录下，并且改名为 authorized_keys，现在准备工作都已完成，关机。*另外有一点注意，这里可能还需要配置相关目录和文件的访问权限*
 
 再次以无界面模式启动，然后在主机终端中使用 SSH 命令 ```ssh -p port username@serverip``` 连接，连接成功，这说明 SSH 服务器配置成功，本地也能正常访问，接下来换用 VS Code，执行 Remote-SSH: Connect to Host...，然后按照提示一步步操作，其实内部也是用 SSH 命令的，通常都没问题。VS Code 连接上以后，执行打开文件夹命令，会列出服务器中的文件夹，打开 Terminal 窗口，就跟之前用的主机终端是一样的。
 
 这里 VS Code 还提供了一个最重要的功能，这就是**端口转发**。因为是做 Web 开发，所以需要使用浏览器来看网页效果。如果服务器部署的 Web 服务器是用公开端口 80，这倒还好，但是如果是其他端口，或者因为安全原因防火墙封了 Web 服务器端口，那么就只能用端口转发了。执行 Remote-SSH: Forward  Port from Active Host...，按照提示输入服务器端口，VS Code 会提示转发到本地的端口。然后即使服务器的端口没有暴露在公网上，也可以用本地端口来访问页面。至此远程开发模式基本跑通，之后会将本地开发中的细节一点点还原到远程开发中。

## 第二步，完善开发环境

### 基本工具

 基本开发工具包获取都比较简单，像 git、nodejs、npm、gulp 都可以直接用 sudo apt install 来安装。
 
 另外在远程连接之前，系统有一些配置要用 Vim 编辑器，但是当输入 Vim 系统居然提示没安装。不是说 Vim 编辑器是 Linux 内置的吗？后来某一刻灵光一闪，记得 Vim 是增强版的编辑器，它的前身是 Vi。于是试了一下，发现好使，没文化真可怕呀！Vim 的使用还需要进一步熟练，起码少量简单的代码修改还是可以考虑使用 Vim 来操作的。
 
 还有一个问题没解决，就是翻墙的梯子。我在其他平台下用的是 windscribe，它在 Ubuntu 下有2种安装方式，一个是注册在仓库中，然后用 apt install 方法安装，但是访问的 domain 被墙了；另一个是用 deb 包，但是安装时提示缺少依赖。还有就是在 Ubuntu 的桌面版的网络连接设置 GUI 界面中配置过，暂时先不研究 VPN 了，但是 Linux 系统有些工具是国外的，以后肯定要用到。

 对于 Linux（Ubuntu）安装软件还了解了一下，在 Windows 平台下基本都是 exe / msi 文件，双击执行就是安装。而 Linux 系统正常应该是下载源代码，然后用 C++ 的编译器 gcc，还有什么 make 文件，进行本地编译，然后把程序所需文件生成并放到各处对应的位置，有系统目录、用户目录、软连接和共享目录，等等。Linux 一般都是命令行界面，所以没有 Windows 平台上的文件图标，可以在程序安装目录下运行程序，如果把程序目录增加到环境变量中，那么可以在任意一个目录下运行程序。后来 Linux 发行版觉得编译的方式太麻烦，尤其是像我这样刚入门的小白，学习起来太难，于是就提出了软件包管理仓库的概念。
 
 RedHat / CentOS / Fedora 系用的是 yum 源，Debian / Ubuntu 系用的是 apt 源，Debian 系的软件包是 .deb，使用 ```sudo dpkg -i packagename.deb``` 来安装。但是这个方式安装软件只安装软件本身，并不会安装依赖包。因为 Linux 世界中的程序员不是每个功能都自己来写，如果有其他人已经写好的，他会直接拿来使用，他引入的这个软件包就是他的程序的依赖包。于是 Ubuntu 就搞出了 apt 源，使用 ```sudo apt-get install packagename``` ，以这种方式安装软件时，如果有依赖包但是本机上没有安装，而 Ubuntu 仓库中恰好有这个软件包，那么它会自动帮你装好依赖包。这样一来，安装的程序就能直接运行，而不必用户自己去寻找并安装依赖包。

 我在研究 Linux 服务器时，发现有个教程给的是 ```sudo apt install packagename``` ，但是有的给的却是 ```sudo apt-get install packagename``` 。原来 apt-get 是先有的命令，但是它只用于获取的功能，还有其他的功能可能用到 apt-cache 等其他命令，这样不便于记忆。因此后来又推出了 apt 命令，它把 apt-* 命令统一了，只需要更改后面的命令动词，比如 install、remove 等等，前面的标识符始终是 apt 不变，这样就简单多了。实际这2个命令执行效果是一样的，但是推荐使用后者。

### MySQL 的安装

 首先要到 MySQL 官网下载一个 deb 包，用 sudo dpkg -i \*.deb 来安装，里面是选择版本并更新依赖包和源的脚本（*默认是8+版本，进入选择界面可以更改为5.7版本，小版本号都是最新的*）。然后用 ```sudo apt install mysql-server``` 安装 MySQL 服务器版本，安装过程中会同时安装依赖包。MySQL 服务的命令如下： ```sudo service mysql status / start / stop / restart``` （查看状态、启动、停止、重启），还有一个命令也可以来确认服务状态： ```ps -ef | grep mysqld``` 。在安装 MySQL 时会输入 root 的密码，这时用 root 用户登录， ```sudo mysql -u username -p``` ，然后创建一个新用户，并设置密码。这个新用户的 domain 要给 % ，因为本地（或虚拟机自身）可以用 localhost 来访问，但是其他机器（或主机）要使用 ip 来访问，% 代表任何 domain 都可以访问。同时额外说一点，root 用户最好把 domain 设置成 localhost，即不允许其他机器远程访问，这样更安全一些。
 
 现在在虚拟机中无论是用 root ，还是个人创建用户都能用 MySQL 命令行管理工具正常访问 MySQL 服务器。而用主机的数据库管理软件却无法成功连接 MySQL 数据库，可能是 3306 端口被防火墙给封了，但是排查后发现没有。网上搜索一番，找到答案了，并且问题和原因之前也碰到过，MySQL 的配置文件中有个 bind-address （可以用 ```netstat -anpt```，如果监听的是127.0.0.1则是本地能访问，如果是0.0.0.0则是任意domain可以访问，类似 % ）。这个配置项默认是被注释掉了，那么如果 MySQL 找不到这个配置项，那么自动用 localhost，这里把注释放开，重启 MySQL 服务即可，现在再回到主机，就可以正常访问数据库了。

### DotNET Core 的安装

*未完待续*
